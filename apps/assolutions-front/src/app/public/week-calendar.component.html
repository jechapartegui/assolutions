<div class="weekcal">
  <!-- Entête (jours) -->
  <div class="header-row">
    <div class="time-spacer">
      <ng-container *ngIf="showNav()">
        <button class="nav-btn" (click)="prevWeek.emit()" title="Semaine précédente">‹</button>
        <button class="nav-btn" (click)="todayWeek.emit()" title="Aujourd’hui">•</button>
        <button class="nav-btn" (click)="nextWeek.emit()" title="Semaine suivante">›</button>
      </ng-container>
    </div>

    <div class="day-header" *ngFor="let d of days()">
      <div class="dow">{{ d.date | date:'EEE' }}</div>
      <div class="dom" *ngIf="showDates()">{{ d.date | date:'d/MM' }}</div>
    </div>
  </div>

  <!-- Corps scrollable : rail heures + colonnes jours -->
  <div class="scroll-body" #scroller>
    <!-- Rail heures -->
    <div class="time-rail" [style.height.px]="gridHeightPx()">
      <div class="time-cell" *ngFor="let h of viewHours()">
        {{ (h < 10 ? '0' + h : h) }}:00
      </div>
      <div class="time-cell last"></div>
    </div>

    <!-- 7 colonnes jours -->
    <div class="day-col"
         *ngFor="let d of days(); trackBy: trackByDay"
         [style.height.px]="gridHeightPx()">
      <div class="hour-cell" *ngFor="let _ of viewHours()"></div>
      <div class="hour-cell last"></div>

      <ng-container *ngFor="let ev of (layoutByDay().get(dayIso(d)) || []); trackBy: trackByEvent">
        <div class="event-card"
             [style.top.%]="ev.top"
             [style.height.%]="ev.height"
             [style.left.%]="ev.left"
             [style.width.%]="ev.width"
             [title]="ev.title + ' • ' + ev.start + '–' + ev.end">
          <div class="ev-title">{{ ev.title }}</div>
          <div class="ev-meta">
            {{ ev.start }}–{{ ev.end }}
            <ng-container *ngIf="ev.location"> • {{ ev.location }}</ng-container>
          </div>

          <!-- RDV/infos + statut (optionnel pour Séances) -->
          <div class="ev-sub" *ngIf="ev.subtitle || (showStatus() && ev.statut)">
            <ng-container *ngIf="ev.subtitle">{{ ev.subtitle }}</ng-container>
            <ng-container *ngIf="showStatus() && ev.statut">
              <span *ngIf="ev.subtitle"> • </span>{{ ev.statut }}
            </ng-container>
          </div>
        </div>
      </ng-container>

      <div class="more-after" *ngIf="dayHasAfter().get(dayIso(d))" title="Autres séances plus tard">⋯</div>
    </div>
  </div>
</div>
